#!/usr/bin/env python3
"""
Test Real Telegram Bot Integration
Verifies the bot is connected to Telegram's API and ready to receive commands
"""
import requests
import json
import time
from datetime import datetime

def test_telegram_api_connection():
    """Test if the bot can connect to Telegram's API"""
    print("üîó Testing Telegram API Connection...")
    print("=" * 50)
    
    bot_token = "7848656841:AAFm6v8KPzn1zPZmHKklXjkIwzQ8fYY25O0"
    
    try:
        # Test getMe endpoint to verify bot token
        response = requests.get(
            f"https://api.telegram.org/bot{bot_token}/getMe",
            timeout=10
        )
        
        if response.status_code == 200:
            bot_info = response.json()
            if bot_info.get('ok'):
                bot_data = bot_info.get('result', {})
                print(f"‚úÖ Bot connected successfully!")
                print(f"   Bot ID: {bot_data.get('id')}")
                print(f"   Bot Username: @{bot_data.get('username')}")
                print(f"   Bot Name: {bot_data.get('first_name')}")
                print(f"   Can Join Groups: {bot_data.get('can_join_groups')}")
                print(f"   Can Read Messages: {bot_data.get('can_read_all_group_messages')}")
                return True, bot_data
            else:
                print(f"‚ùå Bot API error: {bot_info.get('description')}")
                return False, None
        else:
            print(f"‚ùå HTTP Error: {response.status_code}")
            return False, None
            
    except Exception as e:
        print(f"‚ùå Connection error: {str(e)}")
        return False, None

def test_bot_commands_setup():
    """Test if bot commands are properly set up"""
    print("\nüìã Testing Bot Commands Setup...")
    print("=" * 50)
    
    bot_token = "7848656841:AAFm6v8KPzn1zPZmHKklXjkIwzQ8fYY25O0"
    
    try:
        # Get bot commands
        response = requests.get(
            f"https://api.telegram.org/bot{bot_token}/getMyCommands",
            timeout=10
        )
        
        if response.status_code == 200:
            commands_info = response.json()
            if commands_info.get('ok'):
                commands = commands_info.get('result', [])
                print(f"‚úÖ Bot has {len(commands)} commands configured")
                
                if commands:
                    print("   Configured commands:")
                    for cmd in commands[:10]:  # Show first 10 commands
                        print(f"   /{cmd.get('command')} - {cmd.get('description')}")
                    if len(commands) > 10:
                        print(f"   ... and {len(commands) - 10} more commands")
                else:
                    print("   No commands configured yet")
                
                return True, commands
            else:
                print(f"‚ùå Commands API error: {commands_info.get('description')}")
                return False, []
        else:
            print(f"‚ùå HTTP Error: {response.status_code}")
            return False, []
            
    except Exception as e:
        print(f"‚ùå Commands error: {str(e)}")
        return False, []

def test_bot_webhook_info():
    """Test bot webhook configuration"""
    print("\nüîó Testing Webhook Configuration...")
    print("=" * 50)
    
    bot_token = "7848656841:AAFm6v8KPzn1zPZmHKklXjkIwzQ8fYY25O0"
    
    try:
        # Get webhook info
        response = requests.get(
            f"https://api.telegram.org/bot{bot_token}/getWebhookInfo",
            timeout=10
        )
        
        if response.status_code == 200:
            webhook_info = response.json()
            if webhook_info.get('ok'):
                webhook_data = webhook_info.get('result', {})
                webhook_url = webhook_data.get('url', '')
                
                if webhook_url:
                    print(f"‚úÖ Webhook configured: {webhook_url}")
                    print(f"   Has Custom Certificate: {webhook_data.get('has_custom_certificate')}")
                    print(f"   Pending Updates: {webhook_data.get('pending_update_count')}")
                    print(f"   Last Error: {webhook_data.get('last_error_message', 'None')}")
                else:
                    print("‚úÖ No webhook configured (using polling mode)")
                    print("   This is correct for development setup")
                
                return True, webhook_data
            else:
                print(f"‚ùå Webhook API error: {webhook_info.get('description')}")
                return False, {}
        else:
            print(f"‚ùå HTTP Error: {response.status_code}")
            return False, {}
            
    except Exception as e:
        print(f"‚ùå Webhook error: {str(e)}")
        return False, {}

def test_local_bot_service():
    """Test local bot service health"""
    print("\nü§ñ Testing Local Bot Service...")
    print("=" * 50)
    
    try:
        # Test health endpoint
        response = requests.get('http://localhost:3002/health', timeout=5)
        
        if response.status_code == 200:
            health_data = response.json()
            print(f"‚úÖ Local bot service healthy")
            print(f"   Status: {health_data.get('status')}")
            print(f"   Uptime: {health_data.get('uptime', 0):.2f} seconds")
            print(f"   Timestamp: {health_data.get('timestamp')}")
            return True
        else:
            print(f"‚ùå Health check failed: {response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå Local service error: {str(e)}")
        return False

def test_service_integration():
    """Test integration between services"""
    print("\nüîÑ Testing Service Integration...")
    print("=" * 50)
    
    services = {
        'LLM Service': 'http://localhost:3003/health',
        'Backend API': 'http://localhost:3001/health',
        'Telegram Bot': 'http://localhost:3002/health'
    }
    
    results = {}
    
    for service_name, url in services.items():
        try:
            response = requests.get(url, timeout=5)
            if response.status_code == 200:
                results[service_name] = "‚úÖ Running"
            elif response.status_code == 503:
                results[service_name] = "‚ö†Ô∏è Degraded"
            else:
                results[service_name] = f"‚ùå Error {response.status_code}"
        except Exception as e:
            results[service_name] = f"‚ùå Offline"
    
    print("Service Status:")
    for service, status in results.items():
        print(f"   {service}: {status}")
    
    # Test LLM service functionality
    print("\nüß† Testing LLM Service Integration...")
    try:
        llm_response = requests.post(
            'http://localhost:3003/generate',
            json={
                "topic": "test telegram bot integration",
                "tone": "professional",
                "length": "short"
            },
            timeout=15
        )
        
        if llm_response.status_code == 200:
            llm_data = llm_response.json()
            if llm_data.get('success'):
                print("‚úÖ LLM service generating content successfully")
                return True
            else:
                print("‚ùå LLM service not generating content")
                return False
        else:
            print(f"‚ùå LLM service error: {llm_response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå LLM integration error: {str(e)}")
        return False

def simulate_campaign_creation():
    """Simulate the complete campaign creation process"""
    print("\nüöÄ Simulating Campaign Creation Process...")
    print("=" * 50)
    
    print("üì± Simulating: User sends '/create_campaign I want to promote my crypto course'")
    
    # Step 1: Content Generation
    print("üîÑ Step 1: Generating campaign content...")
    try:
        content_response = requests.post(
            'http://localhost:3003/generate',
            json={
                "topic": "crypto course promotion for young investors",
                "tone": "educational",
                "length": "medium",
                "platform": "twitter"
            },
            timeout=20
        )
        
        if content_response.status_code == 200:
            content_data = content_response.json()
            if content_data.get('success'):
                print("‚úÖ Campaign content generated")
                content_id = content_data.get('content', {}).get('id', 'Unknown')
                print(f"   Content ID: {content_id}")
            else:
                print("‚ùå Content generation failed")
                return False
        else:
            print(f"‚ùå Content generation HTTP error: {content_response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Content generation error: {str(e)}")
        return False
    
    # Step 2: Content Analysis
    print("üîÑ Step 2: Analyzing content quality...")
    try:
        analysis_response = requests.post(
            'http://localhost:3003/analyze',
            json={"content": "Learn cryptocurrency fundamentals with our comprehensive course designed for young investors"},
            timeout=15
        )
        
        if analysis_response.status_code == 200:
            analysis_data = analysis_response.json()
            if analysis_data.get('success'):
                print("‚úÖ Content analysis completed")
                print(f"   Quality assessment: {analysis_data.get('quality_score', 'N/A')}")
            else:
                print("‚ùå Content analysis failed")
                return False
        else:
            print(f"‚ùå Content analysis HTTP error: {analysis_response.status_code}")
            return False
    except Exception as e:
        print(f"‚ùå Content analysis error: {str(e)}")
        return False
    
    print("‚úÖ Campaign creation simulation completed successfully!")
    return True

def main():
    """Run comprehensive real Telegram bot test"""
    print("ü§ñ X Marketing Platform - Real Telegram Bot Integration Test")
    print("üîë Testing with Real Telegram API Token")
    print("=" * 70)
    print(f"‚è∞ Test started at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print()
    
    # Run all tests
    api_success, bot_info = test_telegram_api_connection()
    commands_success, commands = test_bot_commands_setup()
    webhook_success, webhook_info = test_bot_webhook_info()
    local_service_success = test_local_bot_service()
    integration_success = test_service_integration()
    campaign_success = simulate_campaign_creation()
    
    # Calculate success rate
    tests = [
        api_success,
        commands_success,
        webhook_success,
        local_service_success,
        integration_success,
        campaign_success
    ]
    
    passed_tests = sum(tests)
    total_tests = len(tests)
    success_rate = (passed_tests / total_tests) * 100
    
    # Final summary
    print("\n" + "=" * 70)
    print("üìä REAL TELEGRAM BOT INTEGRATION TEST SUMMARY")
    print("=" * 70)
    print(f"Telegram API Connection: {'‚úÖ CONNECTED' if api_success else '‚ùå FAILED'}")
    print(f"Bot Commands Setup: {'‚úÖ CONFIGURED' if commands_success else '‚ùå FAILED'}")
    print(f"Webhook Configuration: {'‚úÖ CORRECT' if webhook_success else '‚ùå FAILED'}")
    print(f"Local Bot Service: {'‚úÖ RUNNING' if local_service_success else '‚ùå FAILED'}")
    print(f"Service Integration: {'‚úÖ WORKING' if integration_success else '‚ùå FAILED'}")
    print(f"Campaign Simulation: {'‚úÖ SUCCESS' if campaign_success else '‚ùå FAILED'}")
    print()
    print(f"Total Tests: {total_tests}")
    print(f"Passed: {passed_tests}")
    print(f"Failed: {total_tests - passed_tests}")
    print(f"Success Rate: {success_rate:.1f}%")
    print()
    
    if success_rate >= 90:
        print("üéâ EXCELLENT! Telegram bot is fully operational!")
        print("‚úÖ Real Telegram API integration working")
        print("‚úÖ All services communicating properly")
        print("‚úÖ Campaign creation workflow functional")
        print("‚úÖ Ready for production use!")
    elif success_rate >= 70:
        print("‚ö†Ô∏è  GOOD! Most functionality working")
        print("‚úÖ Core integration operational")
        print("‚ö†Ô∏è  Minor issues to resolve")
    else:
        print("‚ùå NEEDS WORK! Major integration issues")
        print("‚ùå Critical functionality not working")
        print("‚ùå Not ready for production")
    
    if bot_info:
        print(f"\nü§ñ Bot Ready: @{bot_info.get('username')} is live and connected!")
        print("üì± Users can now send commands to the bot on Telegram")
        print("üöÄ Natural language campaign creation is operational")
    
    print(f"\n‚è∞ Test completed at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    return success_rate

if __name__ == "__main__":
    main()
